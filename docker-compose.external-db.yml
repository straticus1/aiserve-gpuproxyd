# Docker Compose configuration for using external PostgreSQL and Redis
# Usage: docker-compose -f docker-compose.external-db.yml up -d
#
# This configuration assumes you have PostgreSQL and Redis running externally.
# Configure via environment variables or .env file:
#   DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME
#   REDIS_HOST, REDIS_PORT, REDIS_PASSWORD

services:
  server:
    build: .
    container_name: gpuproxy-server
    environment:
      # Database (external - configure in .env or environment)
      - DB_HOST=${DB_HOST:-localhost}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-gpuproxy}
      - DB_SSLMODE=${DB_SSLMODE:-prefer}
      - DB_USE_PGBOUNCER=${DB_USE_PGBOUNCER:-false}
      - DB_MAX_CONNS=${DB_MAX_CONNS:-25}
      - DB_MIN_CONNS=${DB_MIN_CONNS:-5}
      - DB_MAX_CONN_LIFETIME=${DB_MAX_CONN_LIFETIME:-1h}
      - DB_MAX_CONN_IDLE_TIME=${DB_MAX_CONN_IDLE_TIME:-30m}
      - DB_HEALTH_CHECK_PERIOD=${DB_HEALTH_CHECK_PERIOD:-1m}
      - DB_CONNECT_TIMEOUT=${DB_CONNECT_TIMEOUT:-5s}

      # Redis (external - configure in .env or environment)
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}
      - REDIS_MIN_IDLE_CONNS=${REDIS_MIN_IDLE_CONNS:-5}
      - SESSION_MODE=${SESSION_MODE:-balanced}

      # Server
      - SERVER_HOST=${SERVER_HOST:-::}
      - SERVER_PORT=${SERVER_PORT:-8080}
      - GRPC_PORT=${GRPC_PORT:-9090}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Auth
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24h}
      - REFRESH_EXPIRATION=${REFRESH_EXPIRATION:-168h}

      # GPU Providers (optional with GPU_ALLOW_START_WITHOUT_PROVIDERS=true)
      - GPU_ALLOW_START_WITHOUT_PROVIDERS=${GPU_ALLOW_START_WITHOUT_PROVIDERS:-true}
      - GPU_PREFERRED_BACKEND=${GPU_PREFERRED_BACKEND:-auto}
      - VASTAI_API_KEY=${VASTAI_API_KEY}
      - IONET_API_KEY=${IONET_API_KEY}
      - GPU_API_TIMEOUT=${GPU_API_TIMEOUT:-30s}

      # Billing
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - AFTERDARK_API_URL=${AFTERDARK_API_URL:-https://billing.afterdarksys.com}
      - AFTERDARK_API_KEY=${AFTERDARK_API_KEY}
      - CRYPTO_ENABLED=${CRYPTO_ENABLED:-true}

      # Load Balancing
      - LB_ENABLED=${LB_ENABLED:-true}
      - LB_STRATEGY=${LB_STRATEGY:-round_robin}

      # Guard Rails
      - GUARDRAILS_ENABLED=${GUARDRAILS_ENABLED:-false}

      # Logging
      - SYSLOG_ENABLED=${SYSLOG_ENABLED:-false}
      - LOG_FILE=${LOG_FILE}

    ports:
      - "${SERVER_PORT:-8080}:8080"
      - "${GRPC_PORT:-9090}:9090"

    volumes:
      - ./web:/app/web

    restart: unless-stopped

    # Use host networking to access localhost services
    # Comment this out if using remote databases
    network_mode: "host"
